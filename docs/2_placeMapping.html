<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.39">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Place Name Normalization – Sondondo Project Notebooks</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-e26003cea8cd680ca0c55a263523d882.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-2be10d9e998f81ff6e49e26833438aa5.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


</head>

<body class="nav-sidebar docked">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./1_dataCleaning.html">Notebooks</a></li><li class="breadcrumb-item"><a href="./2_placeMapping.html">Place Mapping</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Sondondo Project Notebooks</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Home</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#" role="navigation" aria-expanded="true">
 <span class="menu-text">Notebooks</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./1_dataCleaning.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Data Cleaning</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./2_placeMapping.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Place Mapping</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./3_termExtraction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Textual Variation Analysis for ‘Conditions’ Columns</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./4_personasCreation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Personas Creation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./5_visualizations.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Visualizations</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#" role="navigation" aria-expanded="true">
 <span class="menu-text">Documentation</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./docpages/metadata_dictionary.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Metadata Dictionary</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#data-preparation" id="toc-data-preparation" class="nav-link active" data-scroll-target="#data-preparation">Data Preparation</a></li>
  <li><a href="#automated-place-extraction" id="toc-automated-place-extraction" class="nav-link" data-scroll-target="#automated-place-extraction">Automated Place Extraction</a>
  <ul class="collapse">
  <li><a href="#extract-place-mentions" id="toc-extract-place-mentions" class="nav-link" data-scroll-target="#extract-place-mentions">Extract Place Mentions</a></li>
  <li><a href="#consolidate-and-resolve-places" id="toc-consolidate-and-resolve-places" class="nav-link" data-scroll-target="#consolidate-and-resolve-places">Consolidate and Resolve Places</a></li>
  </ul></li>
  <li><a href="#manual-curation-and-authority-control" id="toc-manual-curation-and-authority-control" class="nav-link" data-scroll-target="#manual-curation-and-authority-control">Manual Curation and Authority Control</a>
  <ul class="collapse">
  <li><a href="#validation-against-manual-normalization" id="toc-validation-against-manual-normalization" class="nav-link" data-scroll-target="#validation-against-manual-normalization">Validation Against Manual Normalization</a></li>
  <li><a href="#authoritative-place-resolution" id="toc-authoritative-place-resolution" class="nav-link" data-scroll-target="#authoritative-place-resolution">Authoritative Place Resolution</a></li>
  </ul></li>
  <li><a href="#database-integration" id="toc-database-integration" class="nav-link" data-scroll-target="#database-integration">Database Integration</a></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary">Summary</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./1_dataCleaning.html">Notebooks</a></li><li class="breadcrumb-item"><a href="./2_placeMapping.html">Place Mapping</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">Place Name Normalization</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>The resulting dataset (<code>data/clean/unique_places.csv</code>) serves as the authoritative lookup table for all place references across the project, enabling consistent spatial analysis and record linkage.</p>
<p>Historical documents present significant challenges in place name identification due to spelling variations, ambiguous toponyms, and evolving geographic nomenclature. This notebook establishes an authoritative gazetteer of unique places mentioned in the Sondondo sacramental records through a two-phase approach:</p>
<ol start="2" type="1">
<li><strong>Manual curation</strong>: Apply expert knowledge to disambiguate problematic cases and link canonical forms to authoritative geographic databases (GeoNames, Getty TGN, World Historical Gazetteer, Wikidata)</li>
<li><strong>Automated extraction</strong>: Identify and preliminarily resolve place mentions using the <code>placeRecognition</code> module</li>
</ol>
<section id="data-preparation" class="level2">
<h2 class="anchored" data-anchor-id="data-preparation">Data Preparation</h2>
<p>We begin by loading the cleaned sacramental records, which have already undergone date normalization and attribute harmonization. Place names at this stage retain their original spelling variations as recorded in the historical documents.</p>
<div id="397b225a" class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="25eb6631" class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>PLACES_MAP <span class="op">=</span> <span class="st">'../data/mappings/places_types.json'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="bd0f8157" class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>BAUTISMOS_HARMONIZED <span class="op">=</span> pd.read_csv(<span class="st">"../data/clean/bautismos_clean.csv"</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>MATRIMONIOS_HARMONIZED <span class="op">=</span> pd.read_csv(<span class="st">"../data/clean/matrimonios_clean.csv"</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>ENTIERROS_HARMONIZED <span class="op">=</span> pd.read_csv(<span class="st">"../data/clean/entierros_clean.csv"</span>)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>BAUTISMOS_HARMONIZED</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">file</th>
<th data-quarto-table-cell-role="th">identifier</th>
<th data-quarto-table-cell-role="th">event_type</th>
<th data-quarto-table-cell-role="th">event_date</th>
<th data-quarto-table-cell-role="th">baptized_name</th>
<th data-quarto-table-cell-role="th">baptized_birth_place</th>
<th data-quarto-table-cell-role="th">baptized_birth_date</th>
<th data-quarto-table-cell-role="th">baptized_legitimacy_status</th>
<th data-quarto-table-cell-role="th">father_name</th>
<th data-quarto-table-cell-role="th">father_lastname</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">godfather_social_condition</th>
<th data-quarto-table-cell-role="th">godmother_name</th>
<th data-quarto-table-cell-role="th">godmother_lastname</th>
<th data-quarto-table-cell-role="th">godmother_social_condition</th>
<th data-quarto-table-cell-role="th">event_place</th>
<th data-quarto-table-cell-role="th">event_geographic_descriptor_1</th>
<th data-quarto-table-cell-role="th">event_geographic_descriptor_2</th>
<th data-quarto-table-cell-role="th">event_geographic_descriptor_3</th>
<th data-quarto-table-cell-role="th">event_geographic_descriptor_4</th>
<th data-quarto-table-cell-role="th">baptized_lastname</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>APAucará LB L001</td>
<td>B001</td>
<td>Bautizo</td>
<td>1790-10-04</td>
<td>domingo</td>
<td>NaN</td>
<td>1790-08-04</td>
<td>Hijo legitimo</td>
<td>lucas</td>
<td>ayquipa</td>
<td>...</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>Pampamarca</td>
<td>Aucara</td>
<td>Pampamarca</td>
<td>NaN</td>
<td>NaN</td>
<td>ayquipa</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>APAucará LB L001</td>
<td>B002</td>
<td>Bautizo</td>
<td>1790-10-06</td>
<td>dominga</td>
<td>NaN</td>
<td>1790-08-04</td>
<td>Hija legitima</td>
<td>juan</td>
<td>lulia</td>
<td>...</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>Pampamarca</td>
<td>Aucara</td>
<td>Pampamarca</td>
<td>NaN</td>
<td>NaN</td>
<td>lulia</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>APAucará LB L001</td>
<td>B003</td>
<td>Bautizo</td>
<td>1790-10-07</td>
<td>bartola</td>
<td>NaN</td>
<td>1790-08-04</td>
<td>Hija legitima</td>
<td>jacinto</td>
<td>quispe</td>
<td>...</td>
<td>NaN</td>
<td>rotonda</td>
<td>pocco</td>
<td>NaN</td>
<td>Pampamarca</td>
<td>Aucara</td>
<td>Pampamarca</td>
<td>NaN</td>
<td>NaN</td>
<td>quispe</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>APAucará LB L001</td>
<td>B004</td>
<td>Bautizo</td>
<td>1790-10-20</td>
<td>francisca</td>
<td>NaN</td>
<td>1790-10-15</td>
<td>Hija legitima</td>
<td>juan</td>
<td>cuebas</td>
<td>...</td>
<td>NaN</td>
<td>ysabel</td>
<td>guillen</td>
<td>NaN</td>
<td>Aucara</td>
<td>Aucara</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>cuebas</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>APAucará LB L001</td>
<td>B005</td>
<td>Bautizo</td>
<td>1790-10-20</td>
<td>pedro</td>
<td>NaN</td>
<td>1790-10-19</td>
<td>Hijo legitimo</td>
<td>santos</td>
<td>manxo</td>
<td>...</td>
<td>NaN</td>
<td>josefa</td>
<td>santiago</td>
<td>NaN</td>
<td>Aucara</td>
<td>Aucara</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>manxo</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6335</td>
<td>APAucará LB L004</td>
<td>B2042</td>
<td>Bautizo</td>
<td>1888-12-10</td>
<td>leocadio</td>
<td>NaN</td>
<td>1888-12-09</td>
<td>Hijo natural, mestizo</td>
<td>miguel</td>
<td>pacheco</td>
<td>...</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>Aucará</td>
<td>Aucará</td>
<td>Aucará</td>
<td>NaN</td>
<td>NaN</td>
<td>pacheco</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">6336</td>
<td>APAucará LB L004</td>
<td>B2043</td>
<td>Bautizo</td>
<td>1888-12-11</td>
<td>mariano concepcion</td>
<td>NaN</td>
<td>1888-12-07</td>
<td>Hijo legítimo, indio</td>
<td>facundo</td>
<td>vega</td>
<td>...</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>Aucará</td>
<td>Aucará</td>
<td>Aucará</td>
<td>NaN</td>
<td>NaN</td>
<td>vega</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6337</td>
<td>APAucará LB L004</td>
<td>B2044</td>
<td>Bautizo</td>
<td>1888-12-12</td>
<td>ambrosio</td>
<td>NaN</td>
<td>1888-12-06</td>
<td>Hijo legítimo, indio</td>
<td>ysidro</td>
<td>ccasane</td>
<td>...</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>Aucará</td>
<td>Aucará</td>
<td>Mayobamba</td>
<td>NaN</td>
<td>NaN</td>
<td>ccasane</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">6338</td>
<td>APAucará LB L004</td>
<td>B2045</td>
<td>Bautizo</td>
<td>1888-12-15</td>
<td>francisco</td>
<td>NaN</td>
<td>1888-11-30</td>
<td>Hijo legítimo, indio</td>
<td>mariano</td>
<td>lopez</td>
<td>...</td>
<td>Indigna de Huaicahuacho</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>Aucará</td>
<td>Aucará</td>
<td>Huaicahuacho</td>
<td>NaN</td>
<td>NaN</td>
<td>lopez</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6339</td>
<td>APAucará LB L004</td>
<td>B2046</td>
<td>Bautizo</td>
<td>1888-12-16</td>
<td>laureana</td>
<td>NaN</td>
<td>1888-12-01</td>
<td>Hija legítima, india</td>
<td>bernarda</td>
<td>champa</td>
<td>...</td>
<td>NaN</td>
<td>manuela</td>
<td>de la cruz</td>
<td>NaN</td>
<td>Aucará</td>
<td>Aucará</td>
<td>Chacralla</td>
<td>NaN</td>
<td>NaN</td>
<td>champa</td>
</tr>
</tbody>
</table>

<p>6340 rows × 27 columns</p>
</div>
</div>
</div>
</section>
<section id="automated-place-extraction" class="level2">
<h2 class="anchored" data-anchor-id="automated-place-extraction">Automated Place Extraction</h2>
<p>The <code>PlaceExtractor</code> identifies place mentions within text fields and applies initial normalization using the geographic type taxonomy defined in <code>places_types.json</code>. This automated process handles straightforward cases but requires manual review for ambiguous toponyms.</p>
<p>We systematically process all place-related columns across the three sacramental record types, applying the extractor to standardize formatting and identify geographic descriptors.</p>
<section id="extract-place-mentions" class="level3">
<h3 class="anchored" data-anchor-id="extract-place-mentions">Extract Place Mentions</h3>
<div id="c136c300" class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> actions.extractors <span class="im">import</span> placeRecognition</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>extractor <span class="op">=</span> placeRecognition.PlaceExtractor()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="baptismal-records" class="level4">
<h4 class="anchored" data-anchor-id="baptismal-records">Baptismal Records</h4>
<div id="2c71a97a" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>bautismos_place_columns <span class="op">=</span> [</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'baptized_birth_place'</span>, <span class="st">'event_place'</span>, <span class="st">'event_geographic_descriptor_1'</span>,</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>        <span class="st">'event_geographic_descriptor_2'</span>, <span class="st">'event_geographic_descriptor_3'</span>,</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">'event_geographic_descriptor_4'</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> bautismos_place_columns:</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> col <span class="kw">in</span> BAUTISMOS_HARMONIZED.columns:</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>        BAUTISMOS_HARMONIZED[col] <span class="op">=</span> extractor.extract_places_per_row(BAUTISMOS_HARMONIZED[col])</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>BAUTISMOS_HARMONIZED[bautismos_place_columns]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">baptized_birth_place</th>
<th data-quarto-table-cell-role="th">event_place</th>
<th data-quarto-table-cell-role="th">event_geographic_descriptor_1</th>
<th data-quarto-table-cell-role="th">event_geographic_descriptor_2</th>
<th data-quarto-table-cell-role="th">event_geographic_descriptor_3</th>
<th data-quarto-table-cell-role="th">event_geographic_descriptor_4</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>NaN</td>
<td>Pampamarca</td>
<td>Aucara</td>
<td>Pampamarca</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>NaN</td>
<td>Pampamarca</td>
<td>Aucara</td>
<td>Pampamarca</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>NaN</td>
<td>Pampamarca</td>
<td>Aucara</td>
<td>Pampamarca</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>NaN</td>
<td>Aucara</td>
<td>Aucara</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>NaN</td>
<td>Aucara</td>
<td>Aucara</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6335</td>
<td>NaN</td>
<td>Aucará</td>
<td>Aucará</td>
<td>Aucará</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">6336</td>
<td>NaN</td>
<td>Aucará</td>
<td>Aucará</td>
<td>Aucará</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6337</td>
<td>NaN</td>
<td>Aucará</td>
<td>Aucará</td>
<td>Mayobamba</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">6338</td>
<td>NaN</td>
<td>Aucará</td>
<td>Aucará</td>
<td>Huaicahuacho</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6339</td>
<td>NaN</td>
<td>Aucará</td>
<td>Aucará</td>
<td>Chacralla</td>
<td>NaN</td>
<td>NaN</td>
</tr>
</tbody>
</table>

<p>6340 rows × 6 columns</p>
</div>
</div>
</div>
</section>
<section id="marriage-records" class="level4">
<h4 class="anchored" data-anchor-id="marriage-records">Marriage Records</h4>
<div id="2b4d557f" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>matrimonios_place_columns <span class="op">=</span> [</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'husband_birth_place'</span>,</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>       <span class="st">'husband_resident_in'</span>, </span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>       <span class="st">'wife_birth_place'</span>, <span class="st">'wife_resident_in'</span>, </span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>       <span class="st">'event_place'</span>, <span class="st">'event_geographic_descriptor_1'</span>, <span class="st">'event_geographic_descriptor_2'</span>,</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>       <span class="st">'event_geographic_descriptor_3'</span>, <span class="st">'event_geographic_descriptor_4'</span>,</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>       <span class="st">'event_geographic_descriptor_5'</span>, <span class="st">'event_geographic_descriptor_6'</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> matrimonios_place_columns:</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> col <span class="kw">in</span> MATRIMONIOS_HARMONIZED.columns:</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>        MATRIMONIOS_HARMONIZED[col] <span class="op">=</span> extractor.extract_places_per_row(MATRIMONIOS_HARMONIZED[col])</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>MATRIMONIOS_HARMONIZED[matrimonios_place_columns]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">husband_birth_place</th>
<th data-quarto-table-cell-role="th">husband_resident_in</th>
<th data-quarto-table-cell-role="th">wife_birth_place</th>
<th data-quarto-table-cell-role="th">wife_resident_in</th>
<th data-quarto-table-cell-role="th">event_place</th>
<th data-quarto-table-cell-role="th">event_geographic_descriptor_1</th>
<th data-quarto-table-cell-role="th">event_geographic_descriptor_2</th>
<th data-quarto-table-cell-role="th">event_geographic_descriptor_3</th>
<th data-quarto-table-cell-role="th">event_geographic_descriptor_4</th>
<th data-quarto-table-cell-role="th">event_geographic_descriptor_5</th>
<th data-quarto-table-cell-role="th">event_geographic_descriptor_6</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Ciudad de Huamanga</td>
<td>Aucara</td>
<td>NaN</td>
<td>NaN</td>
<td>Aucara</td>
<td>Aucara</td>
<td>Huamanga</td>
<td>Coracora</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>Aucara</td>
<td>Aucara</td>
<td>Colca</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Pampamarca</td>
<td>NaN</td>
<td>Pampamarca</td>
<td>NaN</td>
<td>Aucara</td>
<td>Aucara</td>
<td>Pampamarca</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Pampamarca</td>
<td>NaN</td>
<td>Pampamarca</td>
<td>NaN</td>
<td>Pampamarca|santa iglesia</td>
<td>Aucara</td>
<td>Pampamarca</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>Pampamarca|santa iglesia</td>
<td>Aucara</td>
<td>Pampamarca</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1714</td>
<td>Pampamarca</td>
<td>NaN</td>
<td>Pampamarca</td>
<td>NaN</td>
<td>Pampamarca</td>
<td>Aucara</td>
<td>Pampamarca</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1715</td>
<td>Chacralla</td>
<td>NaN</td>
<td>Chacralla</td>
<td>NaN</td>
<td>Chacralla, iglesia vice-parroquial</td>
<td>Aucara</td>
<td>Chacralla</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1716</td>
<td>Chacralla</td>
<td>NaN</td>
<td>Chacralla</td>
<td>NaN</td>
<td>Chacralla, iglesia vice-parroquial</td>
<td>Aucara</td>
<td>Chacralla</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1717</td>
<td>NaN</td>
<td>Aucara</td>
<td>NaN</td>
<td>Aucara</td>
<td>Aucara</td>
<td>Aucara</td>
<td>Queca</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1718</td>
<td>Pampamarca</td>
<td>NaN</td>
<td>Pampamarca</td>
<td>NaN</td>
<td>Pampamarca</td>
<td>Aucara</td>
<td>Pampamarca</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
</tbody>
</table>

<p>1719 rows × 11 columns</p>
</div>
</div>
</div>
</section>
<section id="burial-records" class="level4">
<h4 class="anchored" data-anchor-id="burial-records">Burial Records</h4>
<div id="c8bbe8f8" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>entierros_place_columns <span class="op">=</span> [</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'event_place'</span>, <span class="st">'deceased_birth_place'</span>, <span class="st">'burial_place'</span>, <span class="st">'event_geographic_descriptor_1'</span>,</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'event_geographic_descriptor_2'</span>, <span class="st">'event_geographic_descriptor_3'</span>,</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'event_geographic_descriptor_4'</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> entierros_place_columns:</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> col <span class="kw">in</span> ENTIERROS_HARMONIZED.columns:</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>        ENTIERROS_HARMONIZED[col] <span class="op">=</span> extractor.extract_places_per_row(ENTIERROS_HARMONIZED[col])</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>ENTIERROS_HARMONIZED[entierros_place_columns]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">event_place</th>
<th data-quarto-table-cell-role="th">deceased_birth_place</th>
<th data-quarto-table-cell-role="th">burial_place</th>
<th data-quarto-table-cell-role="th">event_geographic_descriptor_1</th>
<th data-quarto-table-cell-role="th">event_geographic_descriptor_2</th>
<th data-quarto-table-cell-role="th">event_geographic_descriptor_3</th>
<th data-quarto-table-cell-role="th">event_geographic_descriptor_4</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>Aucará</td>
<td>Lucanas</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>Aucará</td>
<td>Lucanas</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>Aucará</td>
<td>Lucanas</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>Aucará</td>
<td>Lucanas</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>Aucará</td>
<td>Lucanas</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2187</td>
<td>Aucara</td>
<td>Santa Ana de Aucara</td>
<td>NaN</td>
<td>Aucara</td>
<td>Santa Ana de Aucara</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2188</td>
<td>Aucara</td>
<td>Pampamarca</td>
<td>NaN</td>
<td>Aucara</td>
<td>Pampamarca</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2189</td>
<td>Aucara</td>
<td>Santa Ana de Aucara</td>
<td>NaN</td>
<td>Aucara</td>
<td>Santa Ana de Aucara</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2190</td>
<td>Aucara</td>
<td>Aucara</td>
<td>NaN</td>
<td>Aucara</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2191</td>
<td>Aucara</td>
<td>Aucara</td>
<td>NaN</td>
<td>Aucara</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
</tbody>
</table>

<p>2192 rows × 7 columns</p>
</div>
</div>
</div>
</section>
</section>
<section id="consolidate-and-resolve-places" class="level3">
<h3 class="anchored" data-anchor-id="consolidate-and-resolve-places">Consolidate and Resolve Places</h3>
<p>The <code>MapPlaces</code> class aggregates all place mentions from the three datasets, identifies unique toponyms, and attempts automated resolution against authoritative gazetteers. The output is suppressed here as it produces verbose logging; results are saved for subsequent manual review.</p>
<div id="322f318b" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>capture</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>bautismos_places <span class="op">=</span> BAUTISMOS_HARMONIZED[bautismos_place_columns]</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>matrimonios_places <span class="op">=</span> MATRIMONIOS_HARMONIZED[matrimonios_place_columns] </span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>entierros_places <span class="op">=</span> ENTIERROS_HARMONIZED[entierros_place_columns]</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>map_places <span class="op">=</span> placeRecognition.MapPlaces([bautismos_places, matrimonios_places, entierros_places], places_map<span class="op">=</span>PLACES_MAP)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>all_unique_places <span class="op">=</span> map_places.resolve_places()</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"All unique places extracted:"</span>)</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(all_unique_places)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="b9e0eda0" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>all_unique_places.to_csv(<span class="st">"../data/interim/unique_places.csv"</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="0d8803d1" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>standardized_places <span class="op">=</span> all_unique_places.loc[all_unique_places[<span class="st">'uri'</span>].notna()]</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>standardized_places.groupby(<span class="st">'uri'</span>).first().reset_index().sort_values(by<span class="op">=</span><span class="st">'standardize_label'</span>).to_csv(<span class="st">"../data/interim/standardized_places.csv"</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="manual-curation-and-authority-control" class="level2">
<h2 class="anchored" data-anchor-id="manual-curation-and-authority-control">Manual Curation and Authority Control</h2>
<p>Automated place resolution, while effective for unambiguous cases, cannot handle toponymic challenges such as:</p>
<ul>
<li><strong>Homonyms</strong>: Multiple places sharing the same name (e.g., “Pampamarca” appears in multiple regions)</li>
<li><strong>Historical name changes</strong>: Places known by different names across time periods</li>
<li><strong>Spelling variations</strong>: Inconsistent orthography in colonial records (e.g., “Ishua” vs “Ischua”)</li>
<li><strong>Ambiguous references</strong>: Generic descriptors that could refer to multiple locations</li>
</ul>
<p>To address these issues, we created <code>data/interim/unique_places_manual.csv</code>, an authority file that maps variant forms (<code>mentioned_as</code>) to canonical place names with verified geographic coordinates and gazetteer identifiers.</p>
<section id="validation-against-manual-normalization" class="level3">
<h3 class="anchored" data-anchor-id="validation-against-manual-normalization">Validation Against Manual Normalization</h3>
<p>We compare the automated extraction results against the manually curated authority file to identify discrepancies and ensure completeness.</p>
<div id="8a1639ee" class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>uplaces <span class="op">=</span> pd.read_csv(<span class="st">'../data/interim/unique_places_manual.csv'</span>)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>set_diff <span class="op">=</span> <span class="bu">set</span>(standardized_places[<span class="st">'standardize_label'</span>]) <span class="op">-</span> <span class="bu">set</span>(uplaces[<span class="st">'manually_normalized_place'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="dd60e552" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>set_diff</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<pre><code>{'Cachihuancaray',
 'Carhuanca',
 'Carlos Fitzcarrald',
 'Ceibo Roto',
 'Champa',
 'Chaupicancha',
 'Chipao',
 'Chuschi',
 'Ciudad Libertad de las Américas',
 'Cochas',
 'Collay',
 'Coracora',
 'Dos de Mayo',
 'Huambo',
 'Huanacopampa',
 'Huancapi',
 'Huancaraylla',
 'Illapata',
 'India Muerta',
 'Indio Piro',
 'Julca',
 'Llusita',
 'Marca',
 'Paico',
 'Paire',
 'Palco',
 'Pausa',
 'Pincocalla',
 'Poma Patacollo',
 'Queca',
 'Querco',
 'San Pedro de Lloc',
 'Santa Anita - Los Ficus',
 'Santa Iglesia',
 'Santa María',
 'Taulli',
 'Yanaccollpa'}</code></pre>
</div>
</div>
</section>
<section id="authoritative-place-resolution" class="level3">
<h3 class="anchored" data-anchor-id="authoritative-place-resolution">Authoritative Place Resolution</h3>
<p>The <code>AuthoritativePlaceResolver</code> applies the manually curated authority file to resolve all place mentions. For each canonical place name, it queries multiple authoritative gazetteers in priority order:</p>
<ol type="1">
<li><strong>GeoNames</strong> - comprehensive global gazetteer with detailed administrative hierarchies</li>
<li><strong>Getty Thesaurus of Geographic Names (TGN)</strong> - art historical geographic authority</li>
<li><strong>World Historical Gazetteer (WHG)</strong> - specialized in historical place names</li>
<li><strong>Wikidata</strong> - linked data resource with extensive geographic coverage</li>
</ol>
<p>This process produces <code>data/clean/unique_places.csv</code>, the authoritative lookup table linking historical place mentions to verified geographic entities with coordinates, hierarchical context, and stable identifiers.</p>
<p><strong>Note</strong>: We extended <code>places_types.json</code> to include “administrative division” as a recognized geographic type, enabling better classification of jurisdictional references in the historical records:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="er">"administrative</span> <span class="er">division":</span> <span class="fu">{</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"geonames"</span><span class="fu">:</span> <span class="st">"A"</span><span class="fu">,</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"wikidata"</span><span class="fu">:</span> <span class="st">"Q5"</span><span class="fu">,</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"tgn"</span><span class="fu">:</span> <span class="st">"administrative divisions"</span><span class="fu">,</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"whg"</span><span class="fu">:</span> <span class="st">"a"</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="abc97ae9" class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>capture</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>manual_data <span class="op">=</span> pd.read_csv(<span class="st">'../data/interim/unique_places_manual.csv'</span>)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>resolver <span class="op">=</span> placeRecognition.AuthoritativePlaceResolver(data<span class="op">=</span>manual_data, places_map<span class="op">=</span>PLACES_MAP)</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>result_df <span class="op">=</span> resolver.resolve_places()</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Resolved places:"</span>)</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(result_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="database-integration" class="level2">
<h2 class="anchored" data-anchor-id="database-integration">Database Integration</h2>
<p>To prepare the gazetteer for relational database storage, we assign a unique integer identifier (<code>place_id</code>) to each canonical place. This serves as the primary key in the places table and enables efficient joins with sacramental records.</p>
<div id="3d7d288d" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>result_df[<span class="st">'place_id'</span>] <span class="op">=</span> result_df.index <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>result_df <span class="op">=</span> result_df.set_index(<span class="st">'place_id'</span>)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>result_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">manually_normalized_place</th>
<th data-quarto-table-cell-role="th">standardize_label</th>
<th data-quarto-table-cell-role="th">language</th>
<th data-quarto-table-cell-role="th">latitude</th>
<th data-quarto-table-cell-role="th">longitude</th>
<th data-quarto-table-cell-role="th">source</th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">uri</th>
<th data-quarto-table-cell-role="th">country_code</th>
<th data-quarto-table-cell-role="th">part_of</th>
<th data-quarto-table-cell-role="th">part_of_uri</th>
<th data-quarto-table-cell-role="th">confidence</th>
<th data-quarto-table-cell-role="th">threshold</th>
<th data-quarto-table-cell-role="th">match_type</th>
<th data-quarto-table-cell-role="th">mentioned_as</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">place_id</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">1</td>
<td>Acobamba</td>
<td>Acobamba</td>
<td>es</td>
<td>-12.07757</td>
<td>-74.87127</td>
<td>GeoNames</td>
<td>8663907.0</td>
<td>http://sws.geonames.org/8663907/</td>
<td>PE</td>
<td></td>
<td></td>
<td>100.0</td>
<td>90.0</td>
<td>exact</td>
<td>[Acobamba]</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">4</td>
<td>Andamarca</td>
<td>Andamarca</td>
<td>es</td>
<td>-15.63833</td>
<td>-70.58848</td>
<td>GeoNames</td>
<td>3947725.0</td>
<td>http://sws.geonames.org/3947725/</td>
<td>PE</td>
<td></td>
<td></td>
<td>100.0</td>
<td>90.0</td>
<td>exact</td>
<td>[Andamarca]</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>Apongo</td>
<td>Apongo</td>
<td>es</td>
<td>-14.01327</td>
<td>-73.93247</td>
<td>GeoNames</td>
<td>3947431.0</td>
<td>http://sws.geonames.org/3947431/</td>
<td>PE</td>
<td></td>
<td></td>
<td>100.0</td>
<td>90.0</td>
<td>exact</td>
<td>[Apongo]</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">8</td>
<td>Aucará</td>
<td>Aucará</td>
<td>es</td>
<td>-14.25000</td>
<td>-74.08333</td>
<td>GeoNames</td>
<td>3947087.0</td>
<td>http://sws.geonames.org/3947087/</td>
<td>PE</td>
<td></td>
<td></td>
<td>100.0</td>
<td>90.0</td>
<td>exact</td>
<td>[Aucara, Aucara Barrio de Mayo, Aucará, Barrio...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12</td>
<td>Huaycahuaycho</td>
<td>Huaycahuaycho</td>
<td>es</td>
<td>-14.15000</td>
<td>-74.01667</td>
<td>GeoNames</td>
<td>3939003.0</td>
<td>http://sws.geonames.org/3939003/</td>
<td>PE</td>
<td></td>
<td></td>
<td>100.0</td>
<td>90.0</td>
<td>exact</td>
<td>[Aucara Huaycahuacho, Huaicahuacho]</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">85</td>
<td>Soras Pata</td>
<td>Soras Pata</td>
<td>es</td>
<td>-14.23741</td>
<td>-70.65011</td>
<td>GeoNames</td>
<td>13238703.0</td>
<td>http://sws.geonames.org/13238703/</td>
<td>PE</td>
<td></td>
<td></td>
<td>100.0</td>
<td>90.0</td>
<td>exact</td>
<td>[Soras]</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">87</td>
<td>Umasi</td>
<td>Umasi</td>
<td>es</td>
<td>-14.89142</td>
<td>-70.68701</td>
<td>GeoNames</td>
<td>13238711.0</td>
<td>http://sws.geonames.org/13238711/</td>
<td>PE</td>
<td></td>
<td></td>
<td>100.0</td>
<td>90.0</td>
<td>exact</td>
<td>[Umaci, Umasi]</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">88</td>
<td>Urubamba</td>
<td>Urubamba</td>
<td>es</td>
<td>-13.30472</td>
<td>-72.11583</td>
<td>GeoNames</td>
<td>3926438.0</td>
<td>http://sws.geonames.org/3926438/</td>
<td>PE</td>
<td></td>
<td></td>
<td>100.0</td>
<td>90.0</td>
<td>exact</td>
<td>[Urabamba]</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">89</td>
<td>Vilcashuamán</td>
<td>Vilcashuamán</td>
<td>es</td>
<td>-13.65361</td>
<td>-73.95306</td>
<td>GeoNames</td>
<td>3926141.0</td>
<td>http://sws.geonames.org/3926141/</td>
<td>PE</td>
<td></td>
<td></td>
<td>100.0</td>
<td>90.0</td>
<td>exact</td>
<td>[Vilcas]</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">90</td>
<td>Villa San Juan</td>
<td>Villa San Juan</td>
<td>es</td>
<td>-6.37252</td>
<td>-79.80292</td>
<td>GeoNames</td>
<td>3820188.0</td>
<td>http://sws.geonames.org/3820188/</td>
<td>PE</td>
<td></td>
<td></td>
<td>100.0</td>
<td>90.0</td>
<td>exact</td>
<td>[Villa de San Juan]</td>
</tr>
</tbody>
</table>

<p>74 rows × 15 columns</p>
</div>
</div>
</div>
<div id="bad8462a" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>result_df.to_csv(<span class="st">"../data/clean/unique_places.csv"</span>, index<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p>This notebook established an authoritative gazetteer for the Sondondo sacramental records through a two-phase normalization process:</p>
<ol type="1">
<li><strong>Automated extraction</strong> identified place mentions across all three sacramental record types</li>
<li><strong>Manual curation</strong> resolved ambiguous toponyms and linked canonical forms to authoritative geographic databases</li>
<li><strong>Authority control</strong> produced a verified lookup table with stable identifiers and coordinates</li>
</ol>
<p>The resulting dataset (<code>data/clean/unique_places.csv</code>) provides:</p>
<ul>
<li>Controlled vocabulary for place names, reducing spelling variations</li>
<li>Geographic coordinates enabling spatial analysis</li>
<li>Links to authoritative gazetteers (GeoNames, TGN, WHG, Wikidata) for interoperability</li>
<li>Hierarchical geographic context (administrative divisions, place types)</li>
<li>Stable identifiers for database integration</li>
</ul>
<p>This gazetteer is essential for subsequent analyses involving geographic mobility, spatial clustering, and linking records across events.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>